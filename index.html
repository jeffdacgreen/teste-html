<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Detector de Fechamento e Reload</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#fafafa; }
    #log { background:#111; color:#0f0; padding:12px; height:250px; overflow:auto; white-space:pre-wrap; border-radius:6px; }
    button, a { margin-top:8px; display:inline-block; }
  </style>
</head>
<body>
  <h2>Detector de Fechamento e Reload</h2>
  <p>Testes: F5, Ctrl+R, bot√£o de atualizar, digitar a mesma URL, clicar em links ou submeter formul√°rios.</p>

  <div id="log"></div>
  <button id="clear">üßπ Limpar logs</button>
  <p><a href="https://example.com" target="_self">Link (mesma aba) ‚Äî testar navega√ß√£o</a></p>

  <form id="demoForm">
    <input name="q" placeholder="Teste" />
    <button type="submit">Enviar form</button>
  </form>

<script>
(function(){
  const logDiv = document.getElementById('log');
  const BEACON_URL = 'https://webhook.site/0cd31602-9d30-4d59-b31e-e45247293d16';

  function append(msg){
    const s = `[${new Date().toLocaleTimeString()}] ${msg}`;
    logDiv.innerText += s + "\n";
    logDiv.scrollTop = logDiv.scrollHeight;
    try {
      const arr = JSON.parse(localStorage.getItem('logs')||'[]');
      arr.push(s);
      localStorage.setItem('logs', JSON.stringify(arr));
    } catch(e){}
    console.log(s);
  }

  // Exibe logs antigos
  try {
    const old = JSON.parse(localStorage.getItem('logs')||'[]');
    if(old.length) logDiv.innerText = old.join("\n") + "\n";
  } catch(e){}

  // Flags
  let isNavClick = false;
  let isFormSubmit = false;
  let isReload = false;

  // Heartbeat: atualiza timestamp a cada 500ms
  setInterval(() => {
    localStorage.setItem('heartbeat', Date.now());
  }, 500);

  // Detecta clique em links
  document.addEventListener('click', ev => {
    const a = ev.target.closest && ev.target.closest('a[href]');
    if(a && a.getAttribute('target')!=='_blank'){
      isNavClick = true;
      append('HOUVE MUDAN√áA DE URL');
    }
  }, true);

  // Detecta submit de forms
  document.addEventListener('submit', ev => {
    isFormSubmit = true;
    append('UM FORMUL√ÅRIO FOI CLICADO');
  }, true);

  // Detecta F5/Ctrl+R
  window.addEventListener('keydown', ev => {
    if(ev.key === 'F5' || ((ev.ctrlKey || ev.metaKey) && (ev.key==='r' || ev.key==='R'))){
      isReload = true;
      append('A P√ÅGINA FOI ATUALIZADA COM F5 (OU CTRL+R, POR EXEMPLO)');
    }
  }, {capture:true});

  // Fun√ß√£o para enviar beacon
  function sendBeacon(eventType){
    try {
      navigator.sendBeacon(BEACON_URL, JSON.stringify({event:eventType, ts:new Date().toISOString()}));
    } catch(e){}
  }

  // unload
  window.addEventListener('unload', ()=>{
    const lastHeartbeat = parseInt(localStorage.getItem('heartbeat')||0,10);
    const now = Date.now();
    const heartbeatThreshold = 1000; // 1s

    const probableReload = (isReload || (now - lastHeartbeat < heartbeatThreshold));

    if(probableReload){
      append('A P√ÅGINA FOI RECARREGADA (prov√°vel F5, Ctrl+R ou bot√£o atualizar)');
      sendBeacon('reload');
    } else if(!isNavClick && !isFormSubmit){
      append('A P√ÅGINA FECHOU');
      sendBeacon('fechamento');
    }
    // Limpa flags
    isNavClick = false;
    isFormSubmit = false;
    isReload = false;
  });

  // Limpar logs
  document.getElementById('clear').addEventListener('click', ()=>{
    localStorage.removeItem('logs');
    localStorage.removeItem('lastUrl');
    localStorage.removeItem('heartbeat');
    logDiv.innerText = '';
    append('Logs limpos manualmente.');
  });

  append('Detector inicializado.');
})();
</script>
</body>
</html>
