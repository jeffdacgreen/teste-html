<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Detector de Fechamento e Reload</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#fafafa; }
    #log { background:#111; color:#0f0; padding:12px; height:250px; overflow:auto; white-space:pre-wrap; border-radius:6px; }
    button, a { margin-top:8px; display:inline-block; }
  </style>
</head>
<body>
  <h2>Detector de Fechamento, Reload e Navega√ß√£o</h2>
  <p>Testes: F5, Ctrl+R, bot√£o de atualizar, digitar a mesma URL, clicar em links ou submeter formul√°rios.</p>

  <div id="log"></div>
  <button id="clear">üßπ Limpar logs</button>
  <p><a href="https://example.com" target="_self">Link (mesma aba) ‚Äî testar navega√ß√£o</a></p>

  <form id="demoForm">
    <input name="q" placeholder="Teste" />
    <button type="submit">Enviar form</button>
  </form>

<script>
(function(){
  const logDiv = document.getElementById('log');
  const BEACON_URL = 'https://webhook.site/0cd31602-9d30-4d59-b31e-e45247293d16';

  // Fun√ß√£o para adicionar log na tela e no localStorage
  function append(msg){
    const s = `[${new Date().toLocaleTimeString()}] ${msg}`;
    logDiv.innerText += s + "\n";
    logDiv.scrollTop = logDiv.scrollHeight;
    try {
      const arr = JSON.parse(localStorage.getItem('logs')||'[]');
      arr.push(s);
      localStorage.setItem('logs', JSON.stringify(arr));
    } catch(e){}
    console.log(s);
  }

  // Exibe logs antigos
  try {
    const old = JSON.parse(localStorage.getItem('logs')||'[]');
    if(old.length) logDiv.innerText = old.join("\n") + "\n";
  } catch(e){}

  // Flags proativas
  let isNavClick = false;
  let isFormSubmit = false;
  let isHistoryNav = false;

  // Captura clique em links
  document.addEventListener('click', (ev) => {
    const a = ev.target.closest && ev.target.closest('a[href]');
    if(a && a.getAttribute('target')!=='_blank'){
      isNavClick = true;
      append('HOUVE MUDAN√áA DE URL');
    }
  }, true);

  // Captura submit de forms
  document.addEventListener('submit', (ev)=>{
    isFormSubmit = true;
    append('UM FORMUL√ÅRIO FOI CLICADO');
  }, true);

  // Captura navega√ß√µes via history API (SPAs)
  (function(){
    const _push = history.pushState;
    const _replace = history.replaceState;
    history.pushState = function(){
      isHistoryNav = true;
      append('HOUVE MUDAN√áA DE URL');
      return _push.apply(this, arguments);
    };
    history.replaceState = function(){
      isHistoryNav = true;
      append('HOUVE MUDAN√áA DE URL');
      return _replace.apply(this, arguments);
    };
    window.addEventListener('popstate', ()=>{
      isHistoryNav = true;
      append('HOUVE MUDAN√áA DE URL');
    });
  })();

  // beforeunload: decide se √© fechamento ou reload/navega√ß√£o
  window.addEventListener('beforeunload', ()=>{
    const perfNav = performance.getEntriesByType("navigation")[0];
    const navType = perfNav?.type || "navigate";
    const lastUrl = localStorage.getItem('lastUrl') || location.href;

    const isReload = (navType === "reload") || (navType==="navigate" && lastUrl === location.href);
    const isNavigation = isNavClick || isFormSubmit || isHistoryNav || isReload;

    if(isReload){
      append('A P√ÅGINA FOI ATUALIZADA COM F5 (OU CTRL+R, POR EXEMPLO)');
    } else if(!isNavigation){
      append('A P√ÅGINA FECHOU');
      try {
        navigator.sendBeacon(BEACON_URL, JSON.stringify({
          event: 'fechamento',
          ts: new Date().toISOString()
        }));
      } catch(e){}
    }

    // Atualiza √∫ltimo URL para pr√≥ximo ciclo
    localStorage.setItem('lastUrl', location.href);
  });

  // Bot√£o limpar logs
  document.getElementById('clear').addEventListener('click', ()=>{
    localStorage.removeItem('logs');
    localStorage.removeItem('lastUrl');
    logDiv.innerText = '';
    append('Logs limpos manualmente.');
  });

  append('Detector inicializado.');
})();
</script>
</body>
</html>
