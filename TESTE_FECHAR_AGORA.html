<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Detector de Fechamento e Navega√ß√£o</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#fafafa; }
    #log { background:#111; color:#0f0; padding:12px; height:250px; overflow:auto; white-space:pre-wrap; border-radius:6px; }
    button, a { margin-top:8px; display:inline-block; }
  </style>
</head>
<body>
  <h2>Detector de Fechamento, Reload e Navega√ß√£o</h2>
  <p>Testes: F5, Ctrl+R, clicar em links, submeter formul√°rios ou fechar a aba.</p>

  <div id="log"></div>
  <button id="clear">üßπ Limpar logs</button>
  <p><a href="https://example.com" target="_self">Link (mesma aba) ‚Äî testar navega√ß√£o</a></p>

  <form id="demoForm">
    <input name="q" placeholder="Teste" />
    <button type="submit">Enviar form</button>
  </form>

<script>
(function(){
  const logDiv = document.getElementById('log');

  // Fun√ß√£o para adicionar log na tela e no localStorage
  function append(msg){
    const s = `[${new Date().toLocaleTimeString()}] ${msg}`;
    logDiv.innerText += s + "\n";
    logDiv.scrollTop = logDiv.scrollHeight;
    try {
      const arr = JSON.parse(localStorage.getItem('logs')||'[]');
      arr.push(s);
      localStorage.setItem('logs', JSON.stringify(arr));
    } catch(e){}
    console.log(s);
  }

  // Exibe logs antigos
  try {
    const old = JSON.parse(localStorage.getItem('logs')||'[]');
    if(old.length) logDiv.innerText = old.join("\n") + "\n";
  } catch(e){}

  // Flags proativas
  let isReload = false;
  let isNavClick = false;
  let isFormSubmit = false;
  let isHistoryNav = false;

  // Captura teclas F5 e Ctrl/Meta+R
  window.addEventListener('keydown', (ev) => {
    if (ev.key === 'F5' || ((ev.ctrlKey || ev.metaKey) && (ev.key==='r' || ev.key==='R'))) {
      isReload = true;
      append('FLAG: Tecla de reload detectada (F5 ou Ctrl/Meta+R)');
    }
  }, {capture:true});

  // Captura cliques em links que abrem na mesma aba
  document.addEventListener('click', (ev) => {
    try {
      const a = ev.target.closest && ev.target.closest('a[href]');
      if(a && a.getAttribute('target')!=='_blank'){
        isNavClick = true;
        append(`FLAG: Clique em link detectado (href=${a.getAttribute('href')})`);
      }
    } catch(e){}
  }, true);

  // Captura submiss√µes de forms
  document.addEventListener('submit', (ev)=>{
    isFormSubmit = true;
    append('FLAG: Form submit detectado');
  }, true);

  // Captura navega√ß√µes via history API (SPAs)
  (function(){
    const _push = history.pushState;
    const _replace = history.replaceState;
    history.pushState = function(){
      isHistoryNav = true;
      append('FLAG: history.pushState detectado');
      return _push.apply(this, arguments);
    };
    history.replaceState = function(){
      isHistoryNav = true;
      append('FLAG: history.replaceState detectado');
      return _replace.apply(this, arguments);
    };
    window.addEventListener('popstate', ()=>{
      isHistoryNav = true;
      append('FLAG: popstate detectado');
    });
  })();

  // Intercepta location.reload()
  (function(){
    const _reload = location.reload;
    location.reload = function(){
      isReload = true;
      append('FLAG: location.reload() detectado');
      return _reload.apply(this, arguments);
    };
  })();

  // beforeunload: decide se √© fechamento ou reload/navega√ß√£o
  window.addEventListener('beforeunload', (ev)=>{
    append('beforeunload disparado. Flags => reload:'+isReload+', navClick:'+isNavClick+', formSubmit:'+isFormSubmit+', historyNav:'+isHistoryNav);
    const isNavigation = isReload || isNavClick || isFormSubmit || isHistoryNav;

    if(isNavigation){
      append('DECIS√ÉO: Reload/Navega√ß√£o. N√£o √© fechamento.');
    } else {
      append('DECIS√ÉO: Prov√°vel fechamento de aba. Log registrado.');
      // Exemplo de sendBeacon (opcional)
      try {
        navigator.sendBeacon('/fake-endpoint', JSON.stringify({event:'fechamento', ts: new Date().toISOString()}));
      } catch(e){}
    }
  });

  // Bot√£o limpar logs
  document.getElementById('clear').addEventListener('click', ()=>{
    localStorage.removeItem('logs');
    logDiv.innerText = '';
    append('Logs limpos manualmente.');
  });

  append('Detector inicializado.');
})();
</script>
</body>
</html>
